<html><head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="description" content="Can LLMs Detect and Refactor Code Clones? An Empirical Study">
	<link href="https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz|Droid+Sans" rel="stylesheet" type="text/css">
	<link rel="stylesheet" type="text/css" media="all" href="css/inland.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link rel="stylesheet" type="text/css" href="css/paper.css">
  <script type="text/javascript" src="js/external.js"></script>
	<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
	<script type="text/javascript" src="js/jquery.scrollTo.js"></script>
	<script type="text/javascript" src="js/template.js"></script>
	<script type="text/javascript" src="js/backontop.js"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>


	<title>Clone Refactoring with Lambda Expressions</title>
</head>

<body>
<div id="wrapper960" class="clearfix">
	<div id="header" class="clearfix">
		<div id="sitetitle" class="clearfix">
			<h1><a href="index.html">Can LLMs Detect and Refactor Code Clones? An Empirical Study</a></h1>
		</div>

		<nav2 id="stickynav">
		<div class="verticalMenu">
			<ul id="nav2">
				<li><a href="#abstract" class="backontop">Abstract</a></li>
				<li><a href="#rscripts" class="backontop">Python Scripts</a></li>
				<li><a href="#experimentaldata" class="backontop">Experiment data</a></li>
				<li><a href="#testresults" class="backontop">Testing results</a></li>
				<li><a href="#tableandlisting" class="backontop">Tables and listings</a></li>
			</ul>
		</div>
		</nav2>
	</div>


    <div id="content" class="clearfix shadow">
		<div id="main" class="left">
			<h2 id="abstract">Abstract</h2>
			<p>
				Large Language Models (LLMs), such as GPT-4, have been widely used in various software engineering tasks, including code generation, code clone detection, refactoring and code review. Recent studies have compared the capability of different LLMs on code clone detection, especially the more complex Type-4 clones. However, despite all those studies, little is known about how LLMs perform on clone classification and refactoring compared to the state-of-the-art tools. In this paper, we explore how is GPT-4o's performance when we consider the results of traditional method JDeodorant as ground truth. We categorized clones into different scenarios, such as whole method clones within the same file, whole method clones in different files, code fragment clones within the same file and code fragment clones in different files. Then we compared the refactoring capability of LLMs, on different scenarios with JDeodorant based on compilation rate, correctness and the use of lambda expressions. Our results
 show that GPT-4o achieved the perfect performance to identify Type-1 clones, but the accuracy dropped to around 51.2% for Type-2 clones and around 85.6% for Type-3 clones. Our findings reveal that while GPT-4o performs well on Type-1 clone classification, it struggles to identify Type-2 and Type-3 clones. For refactoring, GPT-4o achieved good results (84.2% correctness rate) when refactoring Type-1 clones.  However, when clones are Type-2 or Type-3, the correctness of GPT dropped significantly, where it only has 54.6% for Type-2 and 33.1% for Type-3, indicating that GPT-4o struggles to refactor complex cases. However, the overall quality of refactoring code generated by GPT-4o is good, which is clear and easy to understand. 
 We anticipate our work could contribute to a boarder understanding of the capabilities of LLMs on code clone detection and refactoring.
			</p>

			<!--div class="bibtex">
				<pre></pre>
			</div-->
			<h2 id="rscripts">Python Scripts</h2>
			<p>
				You can download the Python scripts we developed from <a href="scripts.zip">here</a>.
				The scripts can be found inside the <code>Scripts</code> folder.
				The script files are:
				</p><ul>
					<li>
						<code>mine.py</code> Contains code to mine clones for each project from their html reports. You need to provide the project name and the path to related html reports folder (can be downloaded from Table 1 Deckard results).
						It will output a csv file, which includes Pair ID (clone group id), Source Folder 1, Package 1, Class 1, Method 1, Start Line 1, End Line 1, Source Folder 2, Package 2, Class 2, Method 2, Start Line 2, End Line 2, Left Code, Right Code and Clone Type.
					</li>
					<li>
						<code>whole_method_clones_same_file.py</code> Contains code for running clone type classification and refactoring on whole method clones in the same file via Azure OpenAI.
					</li>
					<li>
						<code>whole_method_clones_different_files.py</code> Contains code for running clone type classification and refactoring on whole method clones in different files via Azure OpenAI.
					</li>
					<li>
						<code>code_fragment_clones_same_files.py</code> Contains code for running clone type classification and refactoring on code fragment clones in the same file via Azure OpenAI.
					</li>
					<li>
						<code>code_fragment_clones_different_files.py</code> Contains code for running clone type classification and refactoring on code fragment clones in different files via Azure OpenAI.
					</li>
				</ul>
				<p>To run the code clone detection and refactoring scripts, replace the endpoint and api_key variables with your own Azure OpenAI credentials. Also update the file paths to match the directory structure on your machine. </p>
			<h2 id="experimentaldata">Experiment data</h2>
			<p>
				We have provided the resulting files (input and output Excel files, HTML reports, CSV files and real code fragments)
					for every project with Deckard separately in a .7z file, along with the filtered data extracted from their html reports.
				You can click on the corresponding cell to get the file.
			</p>
			<table id="resultstbl">
				<colgroup>
					<col id="projects">
					<col span="" id="deckard" class="tool">
					<col span="" id="Filtered file" class="tool">
				</colgroup>
				<caption>Results</caption>
					<tbody><tr>
						<th>Project<sup><a href="#deckard-citation">[1]</a></sup></th>
						<th>Deckard<sup><a href="#deckard-citation">[1]</a></sup></th>
						<th>Filtered Data</th>
					</tr>
				</tbody>
				<tbody>
					<tr>
						<td><a href="projects/apache-ant-1.7.0.7z">Apache Ant 1.7.0</a></td>
						<td><a href="deckard_results/apache-ant-1.7.0-deckard.7z">Download</a></td>
						<td><a href="filtered_data/filtered_apache.csv">Download</a></td>
					</tr>
					<tr>
						<td><a href="projects/columba-1.4-src.7z">Columba 1.4</a></td>
						<td><a href="deckard_results/columba-1.4-deckard.7z">Download</a></td>
						<td><a href="filtered_data/filtered_columba.csv">Download</a></td>
					</tr>
					<tr>
						<td><a href="projects/emf-2.4.1.7z">EMF 2.4.1</a></td>
						<td><a href="deckard_results/emf-2.4.1-deckard.7z">Download</a></td>
						<td><a href="filtered_data/filtered_emf.csv">Download</a></td>
					</tr>
					<tr>
						<td><a href="projects/jakarta-jmeter-2.3.2.7z">JMeter 2.3.2</a></td>
						<td><a href="deckard_results/jakarta-jmeter-2.3.2-deckard.7z">Download</a></td>
						<td><a href="filtered_data/filtered_jmeter.csv">Download</a></td>
					</tr>
					<tr>
						<td><a href="projects/jEdit-4.2.7z">JEdit 4.2</a></td>
						<td><a href="deckard_results/jedit-4.2-deckard.7z">Download</a></td>
						<td><a href="filtered_data/filtered_jedit.csv">Download</a></td>
					</tr>
					<tr>
						<td><a href="projects/jfreechart-1.0.10-jcommon-src.7z">JFreeChart 1.0.10</a></td>
						<td><a href="deckard_results/jfreechart-1.0.10-deckard.7z">Download</a></td>
						<td><a href="filtered_data/filtered_jfreechart.csv">Download</a></td>
					</tr><tr>
					</tr><tr>
						<td><a href="projects/jruby-1.4.0.7z">JRuby 1.4.0</a></td>
						<td><a href="deckard_results/jruby-1.4.0-deckard.7z">Download</a></td>
						<td><a href="filtered_data/filtered_jruby.csv">Download</a></td>
					</tr>
					<tr>
						<td><a href="projects/hibernate-distribution-3.3.2.GA.7z">Hibernate 3.3.2</a></td>
						<td><a href="deckard_results/hibernate-distribution-3.3.2.GA-deckard.7z">Download</a></td>
						<td><a href="filtered_data/filtered_hibernate.csv">Download</a></td>
					</tr>
					<tr>
						<td><a href="projects/sql12.7z">SQuirreL SQL 3.0.3</a></td>
						<td><a href="deckard_results/sql12-deckard.7z">Download</a></td>
						<td><a href="filtered_data/filtered_squirrel.csv">Download</a></td>
					</tr>
				</tbody>
			</table>
			<p>
				Before running GPT-4o, we did manual inspection on each clone and categorized clones into four scenarios: 
				<ul>
					<li>Whole method clones in the same file: The entire method is identied as a clone and two clones are located in the same file</li>
					<li>Whole method clones in different files: The entire method is identied as a clone and two clones are located in different files</li>
					<li>Code fragment clones in the same file: Only a portion of a method is a clone and two clones are located in the same file</li>
					<li>Code fragment clones in different files: Only a portion of a method is a clone and two clones are located in different files</li>
					<li id="deckard-citation">Reference: [1] Tsantalis, Nikolaos, Davood Mazinanian, and Shahriar Rostami. "Clone refactoring with lambda expressions." 2017 IEEE/ACM 39th International Conference on Software Engineering (ICSE). IEEE, 2017.</li>
				</ul>
				The clone group ids for each scenarios are provided in the following table
			</p>
			
			<table id="resultstbl" style="width: 500px; margin: auto">
				<colgroup>
					<col id="tool" class="tool">
					<col id="download">
				</colgroup>
				<caption>Clone group ids based on different scenarios</caption>
					<tbody><tr>
						<th width="50%">Scenarios</th>
						<th>Type-1</th>
						<th>Type-2</th>
						<th>Type-3</th>
					</tr>
				</tbody>
				<tbody>
					<tr>
						<td><b>Whole method clones in the same file</b></td>
						<td>N/A</td>
						<td><a href="scenarios_ids/Type-2_whole_same.csv">Download</a></td>
						<td><a href="scenarios_ids/Type-3_whole_same.csv">Download</a></td>
					</tr>
					<tr>
						<td><b>Whole method clones in different files</b></td>
						<td><a href="scenarios_ids/Type-1_whole_different.csv">Download</a></td>
						<td><a href="scenarios_ids/Type-2_whole_different.csv">Download</a></td>
						<td><a href="scenarios_ids/Type-3_whole_different.csv">Download</a></td>
					</tr>
					<tr>
						<td><b>Code fragment clones in the same file</b></td>
						<td><a href="scenarios_ids/Type-1_fragment_same.csv">Download</a></td>
						<td><a href="scenarios_ids/Type-2_fragment_same.csv">Download</a></td>
						<td><a href="scenarios_ids/Type-3_fragment_same.csv">Download</a></td>
					</tr>
					<tr>
						<td><b>Code fragment clones in different files</b></td>
						<td><a href="scenarios_ids/Type-1_fragment_different.csv">Download</a></td>
						<td><a href="scenarios_ids/Type-2_fragment_different.csv">Download</a></td>
						<td><a href="scenarios_ids/Type-3_fragment_different.csv">Download</a></td>
					</tr>
				</tbody>
			</table>
			
	
		
			<h2 id="testresults">Testing Results</h2>
			<p>
				To evaluate the correctness of code clone detection and refactoring, we did manual work on the clone pairs
				in JFreeChart project.
				after applying each refactoring.
				The results can be found in the following table.
			</p>
			<table id="resultstbl" style="width: 500px; margin: auto">
				<colgroup>
					<col id="tool" class="tool">
					<col id="download">
				</colgroup>
				<caption>Testing results for JFreeChart</caption>
					<tbody><tr>
						<th width="50%">Scenarios</th>
						<th>Type-1</th>
						<th>Type-2</th>
						<th>Type-3</th>
					</tr>
				</tbody>
				<tbody>
					<tr>
						<td><b>Whole method clones in the same file</b></td>
						<td>N/A</td>
						<td><a href="results/Type-2_whole_same_results.csv">Download</a></td>
						<td><a href="results/Type-3_whole_same_results.csv">Download</a></td>
					</tr>
					<tr>
						<td><b>Whole method clones in different files</b></td>
						<td><a href="results/Type-1_whole_different_results.csv">Download</a></td>
						<td><a href="results/Type-2_whole_different_results.csv">Download</a></td>
						<td><a href="results/Type-3_whole_different_results.csv">Download</a></td>
					</tr>
					<tr>
						<td><b>Code fragment clones in the same file</b></td>
						<td><a href="results/Type-1_fragment_same_results.csv">Download</a></td>
						<td><a href="results/Type-2_fragment_same_results.csv">Download</a></td>
						<td><a href="results/Type-3_fragment_same_results.csv">Download</a></td>
					</tr>
					<tr>
						<td><b>Code fragment clones in different files</b></td>
						<td><a href="results/Type-1_fragment_different_results.csv">Download</a></td>
						<td><a href="results/Type-2_fragment_different_results.csv">Download</a></td>
						<td><a href="results/Type-3_fragment_different_results.csv">Download</a></td>
					</tr>
				</tbody>
			</table>
			<p>
				The clone type and refactoring generated by GPT-4o for whole method clones can be downloaded from <a href="gpt/whole_method_clones_gpt_response.csv">here</a>.
				<br>
				The clone type and refactoring generated by GPT-4o for code fragment clones can be downloaded from <a href="gpt/code_fragment_response.zip">here</a>.
			</p>
			<h2 id="tableandlisting">Tables and listings</h2>
			<h4 style="text-align: center;">Figure: Overview of methodology</h3>
			<img src="figures/Overflow chart.png" alt="" style="display: block; margin: 0 auto; width: 100%;">
			<h3>Tables</h3>
			<h4 style="text-align: center;">Table I: Projects Statistics Overview</h4>
<table border="1" style="border-collapse: collapse; text-align: center; margin: auto;">
  <thead>
    <tr>
      <th>Project</th>
      <th>Contain test files?</th>
      <th>Type-1</th>
      <th>Type-2</th>
      <th>Type-3</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>Apache Ant 1.7.0</td><td>Yes</td><td>98</td><td>352</td><td>120</td><td>570</td></tr>
    <tr><td>Columba 1.4</td><td>Yes</td><td>214</td><td>1126</td><td>100</td><td>1440</td></tr>
    <tr><td>EMF 2.4.1</td><td>No</td><td>94</td><td>2773</td><td>31</td><td>2898</td></tr>
    <tr><td>JMeter 2.3.2</td><td>Yes</td><td>163</td><td>827</td><td>148</td><td>1138</td></tr>
    <tr><td>JEdit 4.2</td><td>No</td><td>88</td><td>197</td><td>57</td><td>342</td></tr>
    <tr><td>JFreeChart 1.0.10</td><td>Yes</td><td>462</td><td>4356</td><td>706</td><td>5524</td></tr>
    <tr><td>JRuby 1.4.0</td><td>Yes</td><td>123</td><td>884</td><td>159</td><td>1166</td></tr>
    <tr><td>Hibernate 3.3.2</td><td>Yes</td><td>219</td><td>777</td><td>169</td><td>1165</td></tr>
    <tr><td>SQuirreL SQL 3.0.3</td><td>Yes</td><td>653</td><td>1672</td><td>145</td><td>2470</td></tr>
  </tbody>
</table>
<h4 style="text-align: center;">Table II: JFreeChart Overview</h4>
<table border="1" style="border-collapse: collapse; text-align: center; margin: auto;">
  <thead>
    <tr>
      <th>Scenarios</th>
      <th>Type-1</th>
      <th>Type-2</th>
      <th>Type-3</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>Whole method clone in same file</td><td>0</td><td>463</td><td>29</td></tr>
    <tr><td>Whole method clone in different files</td><td>78</td><td>2216</td><td>515</td></tr>
    <tr><td>Code fragment clone in same file</td><td>72</td><td>784</td><td>60</td></tr>
    <tr><td>Code fragment clone in different files</td><td>287</td><td>761</td><td>92</td></tr>
    <tr><td>Duplication</td><td>37</td><td>508</td><td>75</td></tr>
    <tr><td>Not in source folder</td><td>17</td><td>128</td><td>9</td></tr>
  </tbody>
</table>
			<p>Table I and Table II shows the statistics overview for projects JDeodorant analyzed, along with the number of clones for each scenarios in JFreeChart</p>
			<h3>Prompts</h3>
			<h4>Prompt for whole method clones detection in different files</h4>
	<pre><code class="language-none">You are a Java developer with expertise in code clone detection and refactoring.
Here are the definitions of clone types:
Type-1: Identical except for whitespace, comments, layout
Type-2: Identical except for variable names, literals, types
Type-3: Mostly similar but with some different statements
Type-4: Different structure but same functionality
Now I have two code snippets, one is in method {['Method 1']} with start line {item['Start Line 1']} and end line {item['End Line 1']} of following java class
{content_1}
Another one is in method {['Method 2']} with start line {['Start Line 2']} and end line {['End Line 2']} of following java class:
{content_2}
With no explanation, directly print these two code snippets, also indicate what types of clones are in these two code snippets. </code></pre>
<h4>Prompt for code fragment clones detection</h4>
<pre><code class="language-none">You are a Java developer with expertise in code clone detection and refactoring.
Here are the definitions of clone types:
Type-1: Identical except for whitespace, comments, layout
Type-2: Identical except for variable names, literals, types
Type-3: Mostly similar but with some different statements
Type-4: Different structure but same functionality
Given the two code snippets below, without any additional explanation, determine and return the appropriate clone type classification:
Code snippet 1:
	['Code fragment 1']
Code snippet 2:
	['Code fragment 2']
</code></pre>
<h4>Prompt for whole method clones refactoring within the same file</h4>
<pre><code class="language-none">Refactor the clones in the given two code snippets by extracting the clones into a single method. 
Ensure that there are no compilation errors and the functionality remains unchanged.
Provide both:
1. The extracted method.
2. The method calls that should replace the clones in the original files.
Do not include any explanations, only provide the refactored code.</code></pre>
<h4>Prompt for whole method clones refactoring in different files</h4>
<pre><code class="language-none">Refactor the clones in the given two code snippets by extracting the clones into a single method. 
Ensure that there are no compilation errors and the functionality remains unchanged.
- Since the clones exist in different files, extracted method will be written into their common superclass.
- Ensure that instance-specific variables (e.g., `this.x`) are passed as parameters to the extracted method to maintain functionality
Provide both:
1. The extracted method.
2. The method calls that should replace the clones in the original files.
Do not include any explanations, only provide the refactored code.
</code></pre>
<h4>Prompt for code fragment clones refactoring within the same file</h4>
<pre><code class="language-none">Both given code snippets are in following java file:
{content1}
Refactor the clones in the given two code snippets by extracting the clones into a single method. 
Ensure that there are no compilation errors and the functionality remains unchanged.
Provide both:
1. The extracted method.
2. The method calls that should replace the clones in the original files.
Do not include any explanations, only provide the refactored code.</code></pre>
<h4>Prompt for code fragment clones refactoring in different files</h4>
<pre><code class="language-none">The first code snippet is in following java file:
{content_1}
The second code snippet is in following java file:
{content_2}
Refactor the clones in the given two code snippets by extracting the clones into a single method. 
Ensure that there are no compilation errors and the functionality remains unchanged.
- Since the clones exist in different files, extracted method will be written into their common superclass.
- Ensure that instance-specific variables (e.g., `this.x`) are passed as parameters to the extracted method to maintain functionality
Provide both:
1. The extracted method.
2. The method calls that should replace the clones in the original files.
Do not include any explanations, only provide the refactored code.</code></pre>
			<h3>Listings</h3>
			<h4>Code clone example</h4>
			<pre><code class="language-java">protected Object[] createItemArray(XYZDataset dataset, int series, int item) { 
	Object[] result = new Object[4];
	result[0] = dataset.getSeriesKey(series).toString();
	Number x = dataset.getX(series, item);
	DateFormat xf = getXDateFormat();
	if (xf != null) {result[1] = xf.format(x); }
	else {result[1] = getXFormat().format(x);}
	Number y = dataset.getY(series, item);
	DateFormat yf = getYDateFormat();
	if (yf != null) {result[2] = yf.format(y);}
	else {result[2] = getYFormat().format(y);}
	Number z = dataset.getZ(series, item);
	if (this.zDateFormat != null) {
		result[3] = this.zDateFormat.format(z); }
	else {result[3] = this.zFormat.format(z);  }   
	return result; }
				
protected Object[] createItemArray(XYZDataset dataset, int series, int item) {
	Object[] result = new Object[4];
	result[0] = dataset.getSeriesKey(series).toString();
	Number x = dataset.getX(series, item);
	DateFormat xf = getXDateFormat();
	if (xf != null) {result[1] = xf.format(x);}
	else {result[1] = getXFormat().format(x);}
	Number y = dataset.getY(series, item);
	DateFormat yf = getYDateFormat();
	if (yf != null) {result[2] = yf.format(y);}
	else {result[2] = getYFormat().format(y);}
	Number z = dataset.getZ(series, item);
	if (this.zDateFormat != null) {
		result[3] = this.zDateFormat.format(z);}
	else {result[3] = this.zFormat.format(z);}
	return result;}
				</code></pre>
			<h4>Code refactoring example</h4>
			<pre><code class="language-java">protected Object[] createItemArrayExtracted(XYZDataset dataset, int series, int item, DateFormat thisZDateFormat, NumberFormat thisZFormat) {
	Object[] result = new Object[4];
	result[0] = dataset.getSeriesKey(series).toString();
	Number x = dataset.getX(series, item);
	DateFormat xf = getXDateFormat();
	if (xf != null) {
		result[1] = xf.format(x);
	} else {
		result[1] = getXFormat().format(x);
	}
	Number y = dataset.getY(series, item);
	DateFormat yf = getYDateFormat();
	if (yf != null) {
		result[2] = yf.format(y);
	} else {
		result[2] = getYFormat().format(y);
	}
	Number z = dataset.getZ(series, item);
	if (thisZDateFormat != null) {
		result[3] = thisZDateFormat.format(z);
	} else {
		result[3] = thisZFormat.format(z);
	}
	return result;
	}
		
//Cloned method 1:
protected Object[] createItemArray(XYZDataset dataset,
int series, int item) {
	return createItemArrayExtracted(dataset, series, item, this.zDateFormat,this.zFormat);
}

//Cloned method 2:
protected Object[] createItemArray(XYZDataset dataset, 
int series, int item) {
	return createItemArrayExtracted(dataset, series, item, this.zDateFormat,this.zFormat);}</code></pre>
	<h4>Examples for zero-shot and one-shot learning</h4>
	<pre><code class="language-java">	For example, 
		Code snippet 
		void sumProb(int n) {
				float sum = 0.0F; //C1
				float prod = 1.0F;
				for (int i=1; i<=n; i++)
					{sum=sum+i;
					 prod = prod * i;
					 foo(sum,prod);}}
		and code snippet
		void sumProb(int n) {
				float sum = 0.0F; //C1
				float prod = 1.0F;
				for (int i=1; i<=n; i++)
						{sum=sum+i;
						prod = prod * i;
						foo(sum,prod);}}
		are Type-1 clones.
		
		Code snippet
		void sumProb(int n) {
				float sum = 0.0F; //C1
				float prod = 1.0F;
				for (int i=1; i<=n; i++)
					{sum=sum+i;
					 prod = prod * i;
					 foo(sum,prod);}}
		and code snippet
		void sumProb(int n) {
				float s = 0.0F; //C1
				float p = 1.0F;
				for (int i=1; i<=n; i++){
					s=s+i;
					p = p * i;
					foo(s,p);}}
		are Type-2 clones.
		
		Code snippet
		void sumProb(int n) {
				float sum = 0.0F; //C1
				float prod = 1.0F;
				for (int i=1; i<=n; i++){
					sum=sum+i;
					prod = prod * i;
					foo(sum,prod);}}
		and code snippet
		void sumProb(int n) {
				float sum = 0.0F; //C1
				float prod = 1.0F;
				for (int i=1; i<=n; i++){
					sum=sum+i;
					prod = prod * i;
					foo(sum,prod,n);}}
		are Type-3 Clones
		
		Code snippet
		void sumProb(int n) {
				float sum = 0.0F; //C1
				float prod = 1.0F;
				for (int i=1; i<=n; i++){
					sum=sum+i;
					prod = prod * i;
					foo(sum,prod);}}
		and code snippet
		void sumProb(int n) {
			float prod = 1.0F;
				float sum = 0.0F; //C1
				for (int i=1; i<=n; i++){
					sum=sum+i;
					prod = prod * i;
					foo(sum,prod);}}
		are Type-4 Clones</code></pre>
		<h4>Example of Type-2 clone misclassification: clone group 454-1-2</h4>
		<pre><code class="language-java">// Code fragment 1 in resovleDomainAxisLocation
else if (location == AxisLocation.TOP_OR_LEFT) {
    if (orientation == PlotOrientation.HORIZONTAL) {
        result = RectangleEdge.LEFT;
    }
    else if (orientation == PlotOrientation.VERTICAL) {
        result = RectangleEdge.TOP;
    }
}
else if (location == AxisLocation.BOTTOM_OR_RIGHT) {
    if (orientation == PlotOrientation.HORIZONTAL) {
        result = RectangleEdge.RIGHT;
    }
    else if (orientation == PlotOrientation.VERTICAL) {
        result = RectangleEdge.BOTTOM;
    }
}
else if (location == AxisLocation.BOTTOM_OR_LEFT) {
    if (orientation == PlotOrientation.HORIZONTAL) {
        result = RectangleEdge.LEFT;
    }

// Code fragment 2 in resovleRangeAxisLocation
else if (location == AxisLocation.TOP_OR_LEFT) {
    if (orientation == PlotOrientation.HORIZONTAL) {
        result = RectangleEdge.TOP;
    }
    else if (orientation == PlotOrientation.VERTICAL) {
        result = RectangleEdge.LEFT;
    }
}
else if (location == AxisLocation.BOTTOM_OR_RIGHT) {
    if (orientation == PlotOrientation.HORIZONTAL) {
        result = RectangleEdge.BOTTOM;
    }
    else if (orientation == PlotOrientation.VERTICAL) {
        result = RectangleEdge.RIGHT;
    }
}
else if (location == AxisLocation.BOTTOM_OR_LEFT) {
    if (orientation == PlotOrientation.HORIZONTAL) {
        result = RectangleEdge.BOTTOM;
    }</code></pre>
	<h4>Conventional approach for clone group 1138-1-4 by JDeodorant</h4>
	<pre><code class="language-java">protected boolean getItemVisibleExtracted(Boolean arg0, Boolean arg1, boolean arg2) {
	Boolean flag = arg0;
	if (flag == null) {
		flag = arg1;
	}
	if (flag != null) {
		return flag.booleanValue();
	} else {
		return arg2;
	}
}
	
#### In `LineAndShapeRenderer.java` (Replacing `getItemLineVisible`)
return getItemVisibleExtracted(this.linesVisible, getSeriesLinesVisible(series), this.baseLinesVisible);

#### In `XYLineAndShapeRenderer.java` (Replacing `getItemShapeVisible`)
return getItemVisibleExtracted(this.shapesVisible, getSeriesShapesVisible(series), this.baseShapesVisible);</code></pre>
<h4>Lambda expression for clone group 1138-1-4 by GPT-4o</h4>
	<pre><code class="language-java">protected boolean getItemVisibility(int series, int item, Boolean globalFlag, java.util.function.Function<Integer, Boolean> seriesFlagGetter, boolean baseFlag) {
	Boolean flag = globalFlag;
	if (flag == null) {
		flag = seriesFlagGetter.apply(series);
	}
	if (flag != null) {
		return flag.booleanValue();
	} else {
		return baseFlag;
	}
}
	
#### In `LineAndShapeRenderer.java` (Replacing `getItemLineVisible`)
return getItemVisibility(series, item, this.linesVisible, 
								this::getSeriesLinesVisible, this.baseLinesVisible);

#### In `XYLineAndShapeRenderer.java` (Replacing `getItemShapeVisible`)
return getItemVisibility(series, item, this.shapesVisible, 
								this::getSeriesShapesVisible, this.baseShapesVisible);</code></pre>
		<h4>Lambda expression approach for clone group 981-2-4 by JDeodorant</h4>
		<pre><code class="language-java">protected Size2D arrangeExtracted(BlockContainer container, Graphics2D g2, RectangleConstraint constraint,
Size2D arg0, Function<Size2D, Double> arg1, Range arg2, Function<Size2D, RectangleConstraint> arg3) {
	Size2D s = arg0;
	if (arg2.contains((double) arg1.apply(s))) {
		return s;
	} else {
		RectangleConstraint c = arg3.apply(s);
		return arrangeFF(container, g2, c);
	}
}

#### In `CenterArrangement` (Replace `arrangeRF`)
return arrangeExtracted(container, g2, constraint, arrangeNF(container, g2, constraint), (Size2D s) -> s.width, constraint.getWidthRange(), (Size2D s) -> constraint.toFixedWidth(constraint.getWidthRange()
.constrain(s.getWidth())));

#### In `FlowArrangement` (Replace `arrangeFR`)
return arrangeExtracted(container, g2, constraint, arrangeFN(container, g2, constraint), (Size2D s) -> s.height, constraint.getHeightRange(), (Size2D s) -> constraint.toFixedHeight(constraint.getHeightRange().
constrain(s.getHeight())));</code></pre>
			<h4>Lambda expression approach for clone group 981-2-4 by GPT-4o</h4>
			<pre><code class="language-java">protected Size2D arrangeRangeConstraint(BlockContainer container, Graphics2D g2, RectangleConstraint constraint, boolean isWidthConstraint, Function<RectangleConstraint, RectangleConstraint> toFixedConstraint, Function<RectangleConstraint, Size2D> arrangeFixed) {
	Size2D s = isWidthConstraint ? arrangeNF(container, g2, constraint) : arrangeFN(container, g2, constraint);
	if ((isWidthConstraint ? constraint.getWidthRange() : constraint.getHeightRange()).
	contains(isWidthConstraint ? s.width : s.height)) {
		return s;
	} else {
		RectangleConstraint c = toFixedConstraint.apply(constraint);
		return arrangeFixed.apply(c);
	}
}

#### In `CenterArrangement` (Replace `arrangeRF`)
protected Size2D arrangeRF(BlockContainer container, Graphics2D g2,
							RectangleConstraint constraint) {
	return arrangeRangeConstraint(
		container, g2, constraint, true,
		c -> c.
toFixedWidth(c.getWidthRange().constrain(c.getWidth())),
		c -> arrangeFF(container, g2, c)
	);
}

#### In `FlowArrangement` (Replace `arrangeFR`)
protected Size2D arrangeFR(BlockContainer container, Graphics2D g2,
							RectangleConstraint constraint) {
	return arrangeRangeConstraint(
		container, g2, constraint, false,
		c -> c.toFixedHeight(c.getHeightRange().
		constrain(c.getHeight())),
		c -> arrangeFF(container, g2, c)
	);
}</code></pre>
<h4>Correct refactoring despite misclassifications of clone type</h4>
<pre><code class="language-java">protected void drawLeftLabels(KeyedValues leftKeys, Graphics2D g2, Rectangle2D plotArea, Rectangle2D linkArea, 
float maxLabelWidth, PiePlotState state) {
		this.labelDistributor.clear();
		double lGap = plotArea.getWidth() * this.labelGap;
		double verticalLinkRadius = state.getLinkArea().getHeight() / 2.0;
		for (int i = 0; i < leftKeys.getItemCount(); i++) {   
			String label = this.labelGenerator.generateSectionLabel(
					this.dataset, leftKeys.getKey(i));
			if (label != null) {
				TextBlock block = TextUtilities.createTextBlock(label, 
						this.labelFont, this.labelPaint, maxLabelWidth, 
						new G2TextMeasurer(g2));
			TextBox labelBox = new TextBox(block);
			labelBox.setBackgroundPaint(
			this.labelBackgroundPaint);
			labelBox.setOutlinePaint(this.
			labelOutlinePaint);
			labelBox.setOutlineStroke(this.labelOutlineStroke);
			labelBox.setShadowPaint(this.
			labelShadowPaint);
			labelBox.setInteriorGap(this.
			labelPadding);
			double theta = Math.toRadians(
						leftKeys.getValue(i).
						doubleValue());
			double baseY = state.getPieCenterY() - Math.sin(theta) 
					* verticalLinkRadius;
			double hh = labelBox.getHeight(g2);
			this.labelDistributor.addPieLabelRecord(new PieLabelRecord(
					leftKeys.getKey(i), theta, baseY, labelBox, hh,
					lGap / 2.0 + lGap / 2.0 * -Math.cos(theta), 0.9 
					+ getExplodePercent(leftKeys.getKey(i))));
			}
		}
		double hh = plotArea.getHeight();
		double gap = hh * getInteriorGap();
	this.labelDistributor.distributeLabels(plotArea.getMinY() + gap, 
				hh - 2 * gap);
		for (int i = 0; i < this.labelDistributor.getItemCount(); i++) {
			drawLeftLabel(g2, state, 
			this.labelDistributor.getPieLabelRecord(i));
		}
	}
--------------------------------------------------
protected void drawRightLabels(KeyedValues keys, Graphics2D g2,
									Rectangle2D plotArea, Rectangle2D linkArea,
									float maxLabelWidth, PiePlotState state) {
	// draw the right labels...
	this.labelDistributor.clear();
	double lGap = plotArea.getWidth() * this.labelGap;
	double verticalLinkRadius = state.getLinkArea().getHeight() / 2.0;
	for (int i = 0; i < keys.getItemCount(); i++) {
		String label = this.labelGenerator.generateSectionLabel(
		this.dataset, keys.getKey(i));
		if (label != null) {
		TextBlock block = TextUtilities.createTextBlock(label,
					this.labelFont, this.labelPaint, maxLabelWidth,
					new G2TextMeasurer(g2));
		TextBox labelBox = new TextBox(block);
	labelBox.setBackgroundPaint(this.labelBackgroundPaint);
	labelBox.setOutlinePaint(this.labelOutlinePaint);
	labelBox.setOutlineStroke(this.labelOutlineStroke);
	labelBox.setShadowPaint(this.labelShadowPaint);
	labelBox.setInteriorGap(this.labelPadding);
	double theta = Math.toRadians(keys.getValue(i).doubleValue());
	double baseY = state.getPieCenterY()
							- Math.sin(theta) * verticalLinkRadius;
	double hh = labelBox.getHeight(g2);
	this.labelDistributor.addPieLabelRecord(new PieLabelRecord(
			keys.getKey(i), theta, baseY, labelBox, hh,
			lGap / 2.0 + lGap / 2.0 * Math.cos(theta),
			0.9 + getExplodePercent(keys.getKey(i))));
		}
	}
	double hh = plotArea.getHeight();
	double gap = hh * getInteriorGap();
this.labelDistributor.distributeLabels(plotArea.getMinY() + gap, hh - 2 * gap);
for (int i = 0; i < this.labelDistributor.getItemCount(); i++) {
		drawRightLabel(g2, state,
		this.labelDistributor.getPieLabelRecord(i));
	}
	}</code></pre>
<h4>Incomplete refactoring: fail to extract entire clones</h4>
<pre><code class="language-java">//Code fragment 1 in LineAndShapeRenderer
    double previous = previousValue.doubleValue();
    double x0;
    if (this.useSeriesOffset) {
        x0 = domainAxis.getCategorySeriesMiddle(
        dataset.getColumnKey(column - 1),
        dataset.getRowKey(row), dataset,
        this.itemMargin, dataArea,
        plot.getDomainAxisEdge());}
    else {
        x0 = domainAxis.getCategoryMiddle(column - 1,
        getColumnCount(), dataArea,
        plot.getDomainAxisEdge());}
    double y0 = rangeAxis.valueToJava2D(previous, dataArea,
        plot.getRangeAxisEdge());
    Line2D line = null;
    if (orientation == PlotOrientation.HORIZONTAL) {
        line = new Line2D.Double(y0, x0, y1, x1);}
    else if (orientation == PlotOrientation.VERTICAL) {
        line = new Line2D.Double(x0, y0, x1, y1);}
    g2.setPaint(getItemPaint(row, column));
    g2.setStroke(getItemStroke(row, column));
    g2.draw(line);
---------------------------------------------------------
//Code fragment 2 in StatisticalLineAndShapeRenderer
    double previous = previousValue.doubleValue();
    double x0;
    if (getUseSeriesOffset()) {
        x0 = domainAxis.getCategorySeriesMiddle(
        dataset.getColumnKey(column - 1),
        dataset.getRowKey(row), dataset,
        getItemMargin(), dataArea,
        plot.getDomainAxisEdge());}
    else {
        x0 = domainAxis.getCategoryMiddle(column - 1,
            getColumnCount(), dataArea,
            plot.getDomainAxisEdge());}
    double y0 = rangeAxis.valueToJava2D(previous, dataArea,
                plot.getRangeAxisEdge());
    Line2D line = null;
    if (orientation == PlotOrientation.HORIZONTAL) {
        line = new Line2D.Double(y0, x0, y1, x1);}
    else if (orientation == PlotOrientation.VERTICAL) {
        line = new Line2D.Double(x0, y0, x1, y1);}
    g2.setPaint(getItemPaint(row, column));
    g2.setStroke(getItemStroke(row, column));
    g2.draw(line);
--------------------------------------------------------
// Extracted method by GPT-4o
protected void drawLineBetweenPoints(Graphics2D g2, PlotOrientation orientation, double x0, double y0, double x1, double y1, int row, int column) {
    Line2D line = null;
    if (orientation == PlotOrientation.HORIZONTAL) {
        line = new Line2D.Double(y0, x0, y1, x1);
    } else if (orientation == PlotOrientation.VERTICAL) {
        line = new Line2D.Double(x0, y0, x1, y1);
    }
    g2.setPaint(getItemPaint(row, column));
    g2.setStroke(getItemStroke(row, column));
    g2.draw(line);
}</code></pre>
<h4>Incomplete refactoring: fail to abstract the common logics of clones</h4>
<pre><code class="language-java">// Code fragment 1 in StackedXYAreaRenderer2
if (orientation == PlotOrientation.VERTICAL) {
	left.moveTo(transX1, transStack1);
	left.lineTo(transX1, transY1);
	left.lineTo(transXLeft, transStackLeft);
}
else {
	left.moveTo(transStack1, transX1);
	left.lineTo(transY1, transX1);
	left.lineTo(transStackLeft, transXLeft);
}
left.closePath();
-------------------------------------------------
// Code fragment 2 in StackedXYAreaRenderer2
if (orientation == PlotOrientation.VERTICAL) {
	right.moveTo(transX1, transStack1);
	right.lineTo(transX1, transY1);
	right.lineTo(transXRight, transStackRight);
}
else {
	right.moveTo(transStack1, transX1);
	right.lineTo(transY1, transX1);
	right.lineTo(transStackRight, transXRight);
}
right.closePath();
------------------------------------------------
// Extracted method by GPT-4o
private void createPolygon(GeneralPath path, PlotOrientation orientation, float transX1, float transY1, float transStack1, 
float transXOther, float transStackOther, boolean isLeft) {
	if (orientation == PlotOrientation.VERTICAL) {
		if (isLeft) {
			path.moveTo(transX1, transY1);
			path.lineTo(transX1, transStack1);
			path.lineTo(transXOther, transStackOther);
		} else {
			path.moveTo(transX1, transStack1);
			path.lineTo(transX1, transY1);
			path.lineTo(transXOther, transStackOther);
		}
	} else {
		if (isLeft) {
			path.moveTo(transY1, transX1);
			path.lineTo(transStack1, transX1);
			path.lineTo(transStackOther, transXOther);
		} else {
			path.moveTo(transStack1, transX1);
			path.lineTo(transY1, transX1);
			path.lineTo(transStackOther, transXOther);
		}
	}
	path.closePath();
}</code></pre>
<h4>Excessive refactoring: expanded</h4>
<pre><code class="language-java">//Code fragment 1 in VectorRenderer
    int itemCount = dataset.getItemCount(series);
    for (int item = 0; item < itemCount; item++) {
        lvalue = dataset.getXValue(series, item);
        uvalue = lvalue;
        minimum = Math.min(minimum, lvalue);
        maximum = Math.max(maximum, uvalue);
--------------------------------------------------
//Code fragment 2 in DatasetUtilities
    for (int item = 0; item < itemCount; item++) {
        lvalue = intervalXYData.getStartXValue(series, item);
        uvalue = intervalXYData.getEndXValue(series, item);
        minimum = Math.min(minimum, lvalue);
        maximum = Math.max(maximum, uvalue);
--------------------------------------------------
//Extracted method by GPT-4o
protected Range calculateRange(XYDataset dataset, boolean includeInterval, BiFunction<Integer, Integer, Double> getStartValue, BiFunction<Integer, Integer, Double> getEndValue) {
    if (dataset == null) {
        throw new IllegalArgumentException("Null 'dataset' argument.");
    }
    double minimum = Double.POSITIVE_INFINITY;
    double maximum = Double.NEGATIVE_INFINITY;
    int seriesCount = dataset.getSeriesCount();
    double lvalue;
    double uvalue;
    for (int series = 0; series < seriesCount; series++) {
        int itemCount = dataset.getItemCount(series);
        for (int item = 0; item < itemCount; item++) {
            lvalue = getStartValue.apply(series, item);
            uvalue = getEndValue.apply(series, item);
            minimum = Math.min(minimum, lvalue);
            maximum = Math.max(maximum, uvalue);
        }}
    if (minimum > maximum) {
        return null;
    } else {
        return new Range(minimum, maximum);
    }
}</code></pre>
<h4>Excessive refactoring: comprehensive</h4>
<pre><code class="language-java">//Code fragment 1 in Hour
    if (o1 instanceof Hour) {
        Hour h = (Hour) o1;
        result = getDay().compareTo(h.getDay());
        if (result == 0) {
            result = this.hour - h.getHour();
        }
    }
    else if (o1 instanceof RegularTimePeriod) {
        result = 0;
    }
     else {
        result = 1;
-------------------------------------------------
//Code fragment 2 in Minute
    if (o1 instanceof Minute) {
        Minute m = (Minute) o1;
        result = getHour().compareTo(m.getHour());
        if (result == 0) {
            result = this.minute - m.getMinute();
        }
    }
    else if (o1 instanceof RegularTimePeriod) {
        result = 0;
    }
    else {
        result = 1;
-------------------------------------------------
//Extracted method by GPT-4o
protected int compareTimePeriod(Object o1, RegularTimePeriod period, int thisValue, int otherValue) {
    int result;
    if (o1.getClass().equals(period.getClass())) {
        RegularTimePeriod other = (RegularTimePeriod) o1;
        result = thisValue - otherValue;
    }
    else if (o1 instanceof RegularTimePeriod) {
        result = 0;
    }
    else {
        result = 1;
    }
    return result;
}</code></pre>
<h4>Success GPT refactoring despite precondition violation for clone 62-1-2</h4>
<pre><code class="language-java">private Shape[] createBlock(double x0, double width, double y0, double y1, boolean inverted, boolean isHorizontal) {
Shape[] result = new Shape[6];

Point2D p00 = isHorizontal ? new Point2D.Double(y0, x0) : new Point2D.Double(x0, y0);
Point2D p01 = isHorizontal ? new Point2D.Double(y0, x0 + width) : new Point2D.Double(x0 + width, y0);
Point2D p02 = new Point2D.Double(p01.getX() + getXOffset(), p01.getY() - getYOffset());
Point2D p03 = new Point2D.Double(p00.getX() + getXOffset(), p00.getY() - getYOffset());

Point2D p0 = isHorizontal ? new Point2D.Double(y1, x0) : new Point2D.Double(x0, y1);
Point2D p1 = isHorizontal ? new Point2D.Double(y1, x0 + width) : new Point2D.Double(x0 + width, y1);
Point2D p2 = new Point2D.Double(p1.getX() + getXOffset(), p1.getY() - getYOffset());
Point2D p3 = new Point2D.Double(p0.getX() + getXOffset(), p0.getY() - getYOffset());

......
}</code></pre>
<h3>Comparison of lambda expression</h3>
<h4>Comparison 3 - lambda expression approach for clone group 981-2-4 by JDeodorant</h4>
<pre><code class="language-java">protected Size2D arrangeExtracted(BlockContainer container, Graphics2D g2, RectangleConstraint constraint,
	Size2D arg0, Function<Size2D, Double> arg1, Range arg2, Function<Size2D, RectangleConstraint> arg3) {
Size2D s = arg0;
if (arg2.contains((double) arg1.apply(s))) {
	return s;
} else {
	RectangleConstraint c = arg3.apply(s);
	return arrangeFF(container, g2, c);
}
}

#### In `CenterArrangement` (Replace `arrangeRF`)
return arrangeExtracted(container, g2, constraint, arrangeNF(container, g2, constraint), (Size2D s) -> s.width, constraint.getWidthRange(), (Size2D s) -> constraint.toFixedWidth(constraint.getWidthRange()
.constrain(s.getWidth())));

#### In `FlowArrangement` (Replace `arrangeFR`)
return arrangeExtracted(container, g2, constraint, arrangeFN(container, g2, constraint), (Size2D s) -> s.height, constraint.getHeightRange(), (Size2D s) -> constraint.toFixedHeight(constraint.getHeightRange().
constrain(s.getHeight())));</code></pre>
<h4>Comparison 3 - lambda expression approach for clone group 981-2-4 by GPT-4o</h4>
<pre><code class="language-java">protected Size2D arrangeRangeConstraint(BlockContainer container, Graphics2D g2, RectangleConstraint constraint, boolean isWidthConstraint, Function<RectangleConstraint, RectangleConstraint> toFixedConstraint, Function<RectangleConstraint, Size2D> arrangeFixed) {
    Size2D s = isWidthConstraint ? arrangeNF(container, g2, constraint) : arrangeFN(container, g2, constraint);
    if ((isWidthConstraint ? constraint.getWidthRange() : constraint.getHeightRange()).
    contains(isWidthConstraint ? s.width : s.height)) {
        return s;
    } else {
        RectangleConstraint c = toFixedConstraint.apply(constraint);
        return arrangeFixed.apply(c);
    }
}

#### In `CenterArrangement` (Replace `arrangeRF`)
protected Size2D arrangeRF(BlockContainer container, Graphics2D g2,
                           RectangleConstraint constraint) {
    return arrangeRangeConstraint(
        container, g2, constraint, true,
        c -> c.
toFixedWidth(c.getWidthRange().constrain(c.getWidth())),
        c -> arrangeFF(container, g2, c)
    );
}

#### In `FlowArrangement` (Replace `arrangeFR`)
protected Size2D arrangeFR(BlockContainer container, Graphics2D g2,
                           RectangleConstraint constraint) {
    return arrangeRangeConstraint(
        container, g2, constraint, false,
        c -> c.toFixedHeight(c.getHeightRange().
        constrain(c.getHeight())),
        c -> arrangeFF(container, g2, c)
    );
}</code></pre>
		</div>
	</div>

	<div id="footer" class="shadow">
		<!-- <script type="text/javascript">footer();</script>		 -->
		<p>Copyright is hidden due to the double-blind review| <a href="http://andreasviklund.com/templates/inland/">Template design</a> by <a href="http://andreasviklund.com/">andreasviklund.com</a></p>
	</div>
</div>



</body></html>